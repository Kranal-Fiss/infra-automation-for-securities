---
- name: Zabbix Monitoring Automation
  hosts: localhost
  connection: local
  vars:
    # 1. server_url 대신 zabbix_url로 사용하고 아래 tasks에서 매칭
    ansible_zabbix_url: "http://172.20.0.4/zabbix/api_jsonrpc.php"
    # 2. 낮은 버전에서는 login_token 대신 user/password를 쓰는 것이 가장 안정적입니다
    ansible_zabbix_user: "Admin"
    ansible_zabbix_pass: "zabbix"

    target_devices:
      - { name: "ceos1", ip: "172.20.0.11", vname: "Core-SW-01" }
      - { name: "ceos2", ip: "172.20.0.12", vname: "Core-SW-02" }
      - { name: "ceos3", ip: "172.20.0.13", vname: "Access-SW-01" }

  tasks:
    - name: Ensure Host Group 'Financial-NW' exists
      community.zabbix.zabbix_group:
        # 파라미터 이름을 낮은 버전 호환용으로 변경
        http_login_user: "{{ ansible_zabbix_user }}"
        http_login_password: "{{ ansible_zabbix_pass }}"
        server_url: "{{ ansible_zabbix_url }}"
        host_groups: "Financial-NW-Group"
        state: present

    - name: Create or Update cEOS Hosts
      community.zabbix.zabbix_host:
        http_login_user: "{{ ansible_zabbix_user }}"
        http_login_password: "{{ ansible_zabbix_pass }}"
        server_url: "{{ ansible_zabbix_url }}"
        host_name: "{{ item.name }}"
        visible_name: "{{ item.vname }}"
        host_groups: "Financial-NW-Group"
        link_templates: 
          - "ICMP Ping"
        status: enabled
        interfaces:
          - type: 1
            main: 1
            useip: 1
            ip: "{{ item.ip }}"
            dns: ""
            port: "10050"
      loop: "{{ target_devices }}"