# ---------------------------------------------------------
    # 3. 호스트 등록 (수정됨: DB 충돌 방지 추가)
    # ---------------------------------------------------------
    # ... (Check if Host exists 태스크는 그대로 두세요) ...

    - name: Create Host
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "host.create"
          params:
            host: "{{ inventory_hostname }}"
            name: "{{ inventory_hostname | upper }}"
            interfaces:
              - type: 2  # SNMP
                main: 1
                useip: 1
                ip: "{{ ansible_host }}"
                dns: ""
                port: "161"
                details:
                  version: 3
                  securityname: "{{ snmp_user }}"
                  securitylevel: 2  # authPriv
                  authprotocol: 1   # SHA
                  authpassphrase: "{{ snmp_auth_pass }}"
                  privprotocol: 1   # AES
                  privpassphrase: "{{ snmp_priv_pass }}"
            groups:
              - groupid: "{{ target_group_id }}"
            templates:
              - templateid: "{{ template_info.json.result[0].templateid }}"
          auth: "{{ zabbix_token }}"
          id: 6
      when: host_info.json.result | length == 0
      register: create_host_resp
      failed_when: "'error' in create_host_resp.json"
      changed_when: true
      throttle: 1  # <--- [핵심] 이 줄을 추가하세요! (동시 실행 금지)