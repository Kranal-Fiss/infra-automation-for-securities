---
- name: Register Arista Switches to Zabbix (Robust API)
  hosts: arista
  connection: local
  gather_facts: no
  # inventory.ini와 group_vars 자동 로드

  tasks:
    # =========================================================
    # 1단계: 호스트 그룹 ID 확보 (무조건 확실한 방법)
    # =========================================================
    - name: Check if Host Group exists
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json-rpc
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: "extend"
            filter:
              name:
                - "{{ zabbix_host_group }}"
          auth: "{{ zabbix_token }}"
          id: 1
      register: first_check
      run_once: true # 한 번만 실행

    - name: Create Host Group (if missing)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json-rpc
        body:
          jsonrpc: "2.0"
          method: "hostgroup.create"
          params:
            name: "{{ zabbix_host_group }}"
          auth: "{{ zabbix_token }}"
          id: 2
      when: first_check.json.result | length == 0
      run_once: true

    # [핵심] 만들었든 있었든, 다시 조회해서 ID를 확정함 (에러 원천 차단)
    - name: Get Final Group ID
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        headers:
          Content-Type: application/json-rpc
        body:
          jsonrpc: "2.0"
          method: "hostgroup.get"
          params:
            output: "extend"
            filter:
              name:
                - "{{ zabbix_host_group }}"
          auth: "{{ zabbix_token }}"
          id: 3
      register: final_group_info
      run_once: true

    - name: Set Group ID Fact (Broadcast to all hosts)
      set_fact:
        target_group_id: "{{ (final_group_info.json.result | first).groupid }}"

    # =========================================================
    # 2단계: 템플릿 ID 조회 (한 번만 실행)
    # =========================================================
    - name: Get Template ID
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "template.get"
          params:
            output: "templateid"
            filter:
              host:
                - "{{ zabbix_template }}"
          auth: "{{ zabbix_token }}"
          id: 4
      register: template_info
      run_once: true

    # =========================================================
    # 3단계: 개별 호스트 등록 (각 장비별 실행)
    # =========================================================
    - name: Check if Host exists
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "host.get"
          params:
            filter:
              host:
                - "{{ inventory_hostname }}"
          auth: "{{ zabbix_token }}"
          id: 5
      register: host_info

    - name: Create Host
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "host.create"
          params:
            host: "{{ inventory_hostname }}"
            name: "{{ inventory_hostname | upper }}"
            interfaces:
              - type: 2  # SNMP
                main: 1
                useip: 1
                ip: "{{ ansible_host }}"
                dns: ""
                port: "161"
                details:
                  version: 3
                  securityname: "{{ snmp_user }}"
                  securitylevel: 3  # authPriv
                  authprotocol: 1   # SHA
                  authpassphrase: "{{ snmp_auth_pass }}"
                  privprotocol: 1   # AES
                  privpassphrase: "{{ snmp_priv_pass }}"
            groups:
              - groupid: "{{ target_group_id }}"
            templates:
              - templateid: "{{ template_info.json.result[0].templateid }}"
          auth: "{{ zabbix_token }}"
          id: 6
      when: host_info.json.result | length == 0
      changed_when: true