---
- name: Dynamic NTP Configuration
  hosts: arista
  gather_facts: no
  connection: network_cli
  # [핵심 수정] cEOS 장비들의 동시 파일 쓰기 충돌 방지를 위해 한 대씩 순차 실행
  serial: 1  
  
  vars:
    ansible_network_os: arista.eos.eos
    ansible_user: admin
    ansible_become: yes
    ansible_become_method: enable
    ansible_ssh_private_key_file: ~/.ssh/ansible_id_rsa
    ansible_network_cli_ssh_type: libssh
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    
    # 타임존 고정
    timezone: "Asia/Seoul"

  pre_tasks:
    # 제어 노드(localhost)에서 장비로 나가는 인터페이스의 IP를 동적으로 추출
    - name: Detect Control Node IP (Dynamic)
      ansible.builtin.shell: "ip route get {{ ansible_host }} | grep -oP 'src \\K\\S+'"
      register: my_ip_check
      delegate_to: localhost
      changed_when: false

    - name: Set NTP Server Variable
      set_fact:
        ntp_server_ip: "{{ my_ip_check.stdout }}"
      
    - name: Debug NTP IP (확인용)
      debug:
        msg: "Detected Control Node IP: {{ ntp_server_ip }}"

  tasks:
    - name: Set Timezone
      arista.eos.eos_config:
        lines:
          - "clock timezone {{ timezone }}"

    - name: Configure NTP Server (Self IP)
      arista.eos.eos_config:
        lines:
          - "ntp server {{ ntp_server_ip }}"
        save_when: modified  # 변경 사항이 있을 때만 저장하여 부하 감소

    - name: Verify NTP
      arista.eos.eos_command:
        commands: "show ntp status"
      register: ntp_res

    - name: Display NTP Status
      debug:
        msg: "{{ ntp_res.stdout_lines[0][0] }}"