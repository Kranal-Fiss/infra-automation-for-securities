---
- name: Dynamic NTP Configuration
  hosts: arista
  gather_facts: no
  connection: network_cli
  # [핵심] cEOS 파일 쓰기 충돌 방지를 위해 한 대씩 순차 실행
  serial: 1  
  
  vars:
    ansible_network_os: arista.eos.eos
    ansible_user: admin
    ansible_become: yes
    ansible_become_method: enable
    ansible_ssh_private_key_file: ~/.ssh/ansible_id_rsa
    ansible_network_cli_ssh_type: libssh
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    
    # 타임존 고정
    timezone: "Asia/Seoul"

  pre_tasks:
    - name: Detect Control Node IP (Dynamic)
      ansible.builtin.shell: "ip route get {{ ansible_host }} | grep -oP 'src \\K\\S+'"
      register: my_ip_check
      delegate_to: localhost
      changed_when: false

    - name: Set NTP Server Variable
      set_fact:
        ntp_server_ip: "{{ my_ip_check.stdout }}"
      
    - name: Debug NTP IP (확인용)
      debug:
        msg: "Detected Control Node IP: {{ ntp_server_ip }}"

  tasks:
    - name: Set Timezone
      arista.eos.eos_config:
        lines:
          - "clock timezone {{ timezone }}"

    - name: Configure NTP Server (Self IP)
      arista.eos.eos_config:
        lines:
          - "ntp server {{ ntp_server_ip }}"
        # [수정] Busy 에러 방지를 위해 여기서 저장하지 않고 다음 태스크에서 처리합니다.
        save_when: never

    - name: Save Configuration (Retry on Busy)
      arista.eos.eos_command:
        commands: "copy running-config startup-config"
      register: save_res
      # [수정] stderr를 직접 찾지 말고, 전체 결과에서 'busy'라는 글자가 있는지 확인
      until: save_res is not failed or "busy" not in (save_res.msg | default(''))
      retries: 5
      delay: 5

    - name: Verify NTP
      arista.eos.eos_command:
        commands: "show ntp status"
      register: ntp_res

    - name: Display NTP Status
      debug:
        msg: "{{ ntp_res.stdout_lines[0][0] }}"