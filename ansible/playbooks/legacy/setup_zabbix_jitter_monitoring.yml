---
- name: NextSecurities 통합 장애 알림 시스템 구축
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../inventory/all.yml
    - ../inventory/group_vars/secrets.yml

  tasks:
    - name: 1. 통합 알림 Action 생성 (복구 알림 규격 최종 교정)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "NextSec_Unified_Action_V5" # 중복 방지를 위한 버전 업데이트
            eventsource: 0
            status: 0
            filter:
              evaltype: 0
              conditions:
                - conditiontype: 4  # Trigger severity
                  operator: 5       # is greater than or equal to
                  value: "3"        # Average 이상
            # 장애 발생 시 알림 (mediatypeid 포함 가능)
            operations:
              - operationtype: 0
                opmessage:
                  default_msg: 0
                  subject: "--- Network Issue Detected ---"
                  message: |
                    - 장비명: {HOST.NAME}
                    - 심각도: {TRIGGER.SEVERITY}
                    - 장애내용: {TRIGGER.NAME}
                    - 발생시각: {EVENT.DATE} {EVENT.TIME}
                  mediatypeid: "43" # 확인된 슬랙 미디어 ID
                opmessage_grp:
                  - usrgrpid: "7" # Zabbix administrators
            # 복구 시 알림 (mediatypeid 제외)
            recovery_operations:
              - operationtype: 11 # Recovery message
                opmessage:
                  default_msg: 0
                  subject: "--- Network Issue Resolved ---"
                  message: |
                    - 복구 장비: {HOST.NAME}
                    - 장애 내용: {TRIGGER.NAME}
                    - 복구 시각: {EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}
                    - 상태: 정상 (OK)
                # mediatypeid를 삭제하여 API 거부 현상 해결
          auth: "{{ zabbix_token }}"
          id: 1
      register: action_result
      failed_when: 
        - action_result.json.error is defined
        - "'already exists' not in action_result.json.error.data" 

    - name: 2. 실행 결과 확인
      ansible.builtin.debug:
        msg: "Action 생성 및 복구 알림 설정이 완료되었습니다. 이제 정상 등록될 것입니다."
      when: action_result.json.result is defined