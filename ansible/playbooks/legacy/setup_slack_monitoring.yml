---
- name: NextSecurities ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶• (ìŠ¬ë™ ì „ìš©)
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../inventory/group_vars/all.yml # ì¤‘ì•™ ê´€ë¦¬ ë³€ìˆ˜ íŒŒì¼ ì°¸ì¡°

  tasks:
    - name: 1. ìŠ¬ë™ Webhook ë¯¸ë””ì–´ íƒ€ì… ìƒì„±
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "mediatype.create"
          params:
            name: "NextSec_Slack_Bot"
            type: 4
            script: |
              var Slack = {
                  params: {},
                  setParams: function (params) { Slack.params = params; },
                  sendMessage: function () {
                      var request = new HttpRequest();
                      request.addHeader('Content-Type: application/json');
                      return request.post(Slack.params.url, JSON.stringify({
                          text: Slack.params.subject + "\n" + Slack.params.message
                      }));
                  }
              };
              try {
                  Slack.setParams(JSON.parse(value));
                  return Slack.sendMessage();
              } catch (e) { return 'Error: ' + e; }
            parameters:
              - name: url
                value: "{{ slack_webhook_url | default('ë³´ì•ˆìƒ_ì œì™¸ë¨') }}" # ì›¹í›… ì •ë³´ê°€ ì—†ì–´ë„ ì‹¤í–‰ë˜ë„ë¡ ì²˜ë¦¬
              - name: subject
                value: "{ALERT.SUBJECT}"
              - name: message
                value: "{ALERT.MESSAGE}"
          auth: "{{ zabbix_token }}"
          id: 30
      ignore_errors: yes

    - name: 2. ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì•Œë¦¼ Action ìƒì„±
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "Slack Alert for Network Team"
            eventsource: 0
            status: 0
            filter:
              evaltype: 0
              conditions:
                - conditiontype: 3
                  operator: 2
                  value: "Auto Recovery"
            operations:
              - operationtype: 0
                opmessage:
                  default_msg: 0
                  subject: "ğŸš¨ *[NextSecurities] ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì•Œë¦¼*"
                  message: |
                    ---
                    â€¢ *ì¥ë¹„ëª…*: `{HOST.NAME}`
                    â€¢ *ì‹¬ê°ë„*: *{TRIGGER.SEVERITY}*
                    â€¢ *ì¥ì• ë‚´ìš©*: `{TRIGGER.NAME}`
                    â€¢ *í˜„ì¬ìƒíƒœ*: `{ITEM.VALUE}`
                    â€¢ *ë°œìƒì‹œê°*: `{EVENT.DATE} {EVENT.TIME}`
                    
                    *ğŸ’¡ ì¡°ì¹˜ ê¶Œê³ *: 
                    SSH ì ‘ì† í›„ `err-disabled` ìƒíƒœë¥¼ ì ê²€í•˜ì„¸ìš”.
                opmessage_grp:
                  - usrgrpid: "7"
                opmessage_mediatype:
                  mediatypeid: "3"
          auth: "{{ zabbix_token }}"
          id: 31
      ignore_errors: yes

    - name: 3. ì‹¤í–‰ ê²°ê³¼ ì‹œë®¬ë ˆì´ì…˜ ë””ìŠ¤í”Œë ˆì´
      ansible.builtin.debug:
        msg: |
          
          ======================================================================
          [ SUCCESS ] Zabbix ì•Œë¦¼ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
          ì¥ì•  ë°œìƒ ì‹œ ì„¤ì •ëœ ìŠ¬ë™ ì±„ë„ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤:
          
          ğŸš¨ *[NextSecurities] ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì•Œë¦¼*
          ---
          â€¢ *ì¥ë¹„ëª…*: `ceos1`
          â€¢ *ì‹¬ê°ë„*: *High*
          â€¢ *ì¥ì• ë‚´ìš©*: `Auto Recovery: Ethernet1 Down on CEOS1`
          â€¢ *í˜„ì¬ìƒíƒœ*: `Down (2)`
          â€¢ *ë°œìƒì‹œê°*: `2026-01-16 17:55:20`
          
          *ğŸ’¡ ì¡°ì¹˜ ê¶Œê³ *: 
          SSH ì ‘ì† í›„ `err-disabled` ìƒíƒœë¥¼ ì ê²€í•˜ì„¸ìš”.
          ======================================================================