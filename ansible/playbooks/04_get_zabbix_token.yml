---
- name: Zabbix API 토큰 발급 및 저장
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Zabbix 접속 정보
    zabbix_url: "http://localhost:8081/api_jsonrpc.php"
    zabbix_user: "Admin"
    zabbix_password: "zabbix"
    secrets_file: "../inventory/group_vars/secrets.yml"

  tasks:
    - name: 1. Zabbix API 로그인 및 토큰 요청
      uri:
        url: "{{ zabbix_url }}"
        method: POST
        body_format: json  # 이 부분이 수정되었습니다.
        body:
          jsonrpc: "2.0"
          method: "user.login"
          params:
            username: "{{ zabbix_user }}"
            password: "{{ zabbix_password }}"
          id: 1
        return_content: true
      register: login_response

    - name: 2. 응답 확인 및 토큰 추출
      set_fact:
        new_zabbix_token: "{{ login_response.json.result }}"
      failed_when: login_response.json.result is not defined

    - name: 3. secrets.yml 파일 생성/업데이트
      copy:
        dest: "{{ secrets_file }}"
        content: |
          zabbix_url: "http://172.20.20.100:8081/api_jsonrpc.php"
          zabbix_user: "{{ zabbix_user }}"
          zabbix_password: "{{ zabbix_password }}"
          zabbix_token: "{{ new_zabbix_token }}"
        mode: '0600'

    - name: 4. 결과 출력
      debug:
        msg: "새로운 Zabbix 토큰이 {{ secrets_file }}에 저장되었습니다."