---
- name: Step 4. PIM-SM 및 RP 멀티캐스트 망 구축 (최종 교정)
  hosts: arista
  gather_facts: no

  tasks:
    - name: 4.1. 전역 멀티캐스트 라우팅 활성화
      arista.eos.eos_config:
        lines:
          - ip multicast-routing

    - name: 4.2. 물리 인터페이스(Ethernet)에만 PIM 활성화
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item.key }}"
      # 인벤토리에 정의된 물리 인터페이스(Ethernet1, 2, 3 등)만 루프를 돕니다.
      loop: "{{ interfaces | dict2items }}"

    - name: 4.3. 정적 RP(Rendezvous Point) 주소 지정
      arista.eos.eos_config:
        lines:
          - ip pim rp-address {{ rp_address }}

    - name: 4.4. IGMP 버전 설정 (호스트 접점 Et3 전용)
      arista.eos.eos_config:
        lines:
          - ip igmp version 2
        parents: interface Ethernet3