---
- name: Step 4. PIM-SM 및 RP 멀티캐스트 망 구축 (Fix)
  hosts: arista
  gather_facts: no

  tasks:
    - name: 4.1. 전역 멀티캐스트 라우팅 활성화
      arista.eos.eos_config:
        lines:
          - ip multicast-routing

    - name: 4.2. 모든 인터페이스(물리+루프백) PIM 활성화
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item }}"
      # 물리 인터페이스 리스트와 Loopback0를 합쳐서 한꺼번에 처리
      loop: "{{ interfaces.keys() | list + ['Loopback 0'] }}"

    - name: 4.3. 정적 RP(Rendezvous Point) 주소 지정
      arista.eos.eos_config:
        lines:
          - ip pim rp-address {{ rp_address }}

    - name: 4.4. IGMP 버전 설정 (호스트 접점 Et3 전용)
      arista.eos.eos_config:
        lines:
          - ip igmp version 2
        parents: interface Ethernet3