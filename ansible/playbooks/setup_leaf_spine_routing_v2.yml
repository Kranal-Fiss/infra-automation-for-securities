---
- name: NextSecurities Leaf-Spine 인프라 및 멀티캐스트 자동화 (V3)
  hosts: arista
  gather_facts: no
  connection: network_cli

  tasks:
    - name: 1. 전역 L3 라우팅 활성화
      arista.eos.eos_config:
        lines:
          - ip routing # 전역 설정 모드에서 실행
        save_when: modified

    - name: 2. 인터페이스 IP 및 Description 설정 (정규화된 방식)
      arista.eos.eos_config:
        # parents를 사용하여 인터페이스 모드로 진입함을 명시합니다
        lines:
          - description {{ item.value.desc }}
          - ip address {{ item.value.ip }}
        parents: "interface {{ item.key }}" # parents 옵션으로 모드 진입 보장
      loop: "{{ interfaces | dict2items }}" # 인벤토리의 interfaces 사전형 데이터를 반복 실행
      save_when: modified

    - name: 3. OSPF (Internal Fabric) 설정
      arista.eos.eos_config:
        lines:
          - router-id {{ ansible_host }}
          - network 10.1.13.0/30 area 0
          - network 10.1.23.0/30 area 0
          - network 192.168.10.0/24 area 0
          - max-lsa 12000
        parents: router ospf 1 # OSPF 설정 모드 진입
      save_when: modified

    - name: 4. iBGP (Spine Interconnect) 설정
      arista.eos.eos_config:
        lines:
          - bgp router-id {{ ansible_host }}
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} remote-as 65001
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} next-hop-self
          - maximum-paths 2
        parents: router bgp 65001 # BGP 설정 모드 진입
      when: inventory_hostname in ['ceos1', 'ceos2']
      save_when: modified

    - name: 5. 멀티캐스트(PIM Sparse-Mode) 활성화
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item.key }}"
      loop: "{{ interfaces | dict2items }}"
      save_when: modified

    - name: 6. 전역 멀티캐스트 설정
      arista.eos.eos_config:
        lines:
          - ip multicast-routing
          - ip pim rp-address 172.20.20.11
      save_when: modified