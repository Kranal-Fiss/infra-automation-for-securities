---
- name: NextSecurities Leaf-Spine 인프라 및 멀티캐스트 자동화 (V6)
  hosts: arista
  gather_facts: no
  connection: network_cli

  tasks:
    - name: 1. 전역 L3 라우팅 활성화
      arista.eos.eos_config:
        lines:
          - ip routing
        save_when: modified

    - name: 2. 인터페이스 IP 및 Description 설정
      arista.eos.eos_config:
        lines:
          - description {{ item.value.desc }}
          - ip address {{ item.value.ip }}
        parents: "interface {{ item.key }}"
        save_when: modified
      loop: "{{ interfaces | dict2items }}"

    - name: 3. OSPF (Internal Fabric) 설정
      arista.eos.eos_config:
        lines:
          - router-id {{ ansible_host }}
          - network 10.1.13.0/30 area 0
          - network 10.1.23.0/30 area 0
          - network 192.168.10.0/24 area 0
          - max-lsa 12000
        parents: router ospf 1
        save_when: modified

    - name: 4. iBGP (Spine Interconnect) 설정 (문법 교정)
      arista.eos.eos_config:
        lines:
          # EOS BGP 컨텍스트 내에서 bgp 접두사를 포함한 전체 명령어를 사용합니다
          - bgp router-id {{ ansible_host }}
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} remote-as 65001
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} next-hop-self
          - maximum-paths 2
        parents: router bgp 65001
        save_when: modified
      when: inventory_hostname in ['ceos1', 'ceos2']

    - name: 5. 멀티캐스트(PIM Sparse-Mode) 인터페이스 설정
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item.key }}"
        save_when: modified
      loop: "{{ interfaces | dict2items }}"

    - name: 6. 전역 멀티캐스트 및 RP 설정
      arista.eos.eos_config:
        lines:
          - ip multicast-routing
          - ip pim rp-address 172.20.20.11
        save_when: modified