---
- name: NextSecurities Leaf-Spine 인프라 통합 자동화 (AS 65100 버전)
  hosts: arista
  gather_facts: no
  connection: network_cli

  tasks:
    - name: 1. 전역 L3 라우팅 활성화
      arista.eos.eos_config:
        lines:
          - ip routing
        save_when: modified

    - name: 2. 인터페이스 IP 및 Description 설정
      arista.eos.eos_config:
        lines:
          - description {{ item.value.desc }}
          - ip address {{ item.value.ip }}
        parents: "interface {{ item.key }}"
        save_when: modified
      loop: "{{ interfaces | dict2items }}"

    - name: 3. OSPF (Internal Fabric) 설정
      arista.eos.eos_config:
        lines:
          - router-id {{ ansible_host }}
          - network 10.1.13.0/30 area 0
          - network 10.1.23.0/30 area 0
          - network 192.168.10.0/24 area 0
          - max-lsa 12000
        parents: router ospf 1
        save_when: modified

    - name: 4. iBGP (Spine Interconnect) 설정 - AS 65100 적용
      arista.eos.eos_config:
        lines:
          # 직접 확인하신 문법에 따라 'bgp' 접두사 없이 router-id 설정
          - router-id {{ ansible_host }}
          # 랩 표준 AS 65100을 사용하여 Spine 간 피어링 수행
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} remote-as 65100
          - neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} next-hop-self
          - maximum-paths 2 # Active-Active ECMP 활성화를 위한 핵심 옵션
          # 주소 가계 설정을 통해 유니캐스트 트래픽 활성화
          - address-family ipv4
          -  neighbor 10.1.12.{{ '2' if inventory_hostname == 'ceos1' else '1' }} activate
        parents: router bgp 65100
        save_when: modified
      when: inventory_hostname in ['ceos1', 'ceos2']

    - name: 5. 인터페이스별 멀티캐스트(PIM Sparse-Mode) 활성화
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item.key }}"
        save_when: modified
      loop: "{{ interfaces | dict2items }}"

    - name: 6. 전역 멀티캐스트 및 RP 설정
      arista.eos.eos_config:
        lines:
          - ip multicast-routing
          - ip pim rp-address 172.20.20.11 # ceos1을 RP로 지정하여 멀티캐스트 경로 집중
        save_when: modified