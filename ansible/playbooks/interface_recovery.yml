---
- name: Auto Recovery for err-disabled Interfaces
  hosts: arista
  gather_facts: no

  tasks:
    # 1. 인터페이스 상태 정보 가져오기
    - name: Get interface status
      arista.eos.eos_command:
        commands:
          - show interfaces status
      register: interface_output

    # 2. errdisabled 상태인 인터페이스 파싱 (정규식 활용)
    - name: Parse err-disabled interfaces
      set_fact:
        failed_interfaces: "{{ interface_output.stdout[0] | regex_findall('(\\w+\\d+/\\d+|Et\\d+) .* errdisabled') }}"

    # 3. 발견된 인터페이스가 있을 경우 알림
    - name: Notify found err-disabled interfaces
      debug:
        msg: "Warning! Found err-disabled interface on {{ inventory_hostname }}: {{ failed_interfaces }}"
      when: failed_interfaces | length > 0

    # 4. 복구 작업: shutdown -> no shutdown
    - name: Recover interfaces (Shut -> No-shut)
      arista.eos.eos_config:
        lines:
          - shutdown
          - no shutdown
        parents: "interface {{ item }}"
      loop: "{{ failed_interfaces }}"
      when: failed_interfaces | length > 0

    # 5. 복구 결과 통보 (간단한 디버그)
    - name: Recovery completion message
      debug:
        msg: "Successfully flapped {{ item }} on {{ inventory_hostname }}"
      loop: "{{ failed_interfaces }}"
      when: failed_interfaces | length > 0