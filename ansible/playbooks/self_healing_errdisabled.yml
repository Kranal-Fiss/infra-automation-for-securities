---
# [Play 1] Arista 장비 SNMP 트랩 설정 (생략 - 이전과 동일하게 유지)
- name: Step 1 - Configure SNMP Traps and Interface Status
  hosts: arista
  gather_facts: no
  connection: network_cli
  tasks:
    - name: 1-1. 글로벌 SNMP 트랩 설정
      arista.eos.eos_config:
        lines:
          - snmp-server host 172.20.20.1 version 3 priv {{ snmp_user }} udp-port 162
          - snmp-server enable traps snmp link-down
          - snmp-server enable traps snmp link-up
          - snmp-server enable traps entity

# [Play 2] Zabbix 설정 자동화 (아이템/트리거/액션 생성)
- name: Step 2 - Configure Zabbix objects via API
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - "../inventory/group_vars/all.yml"

  tasks:
    # 트리거가 참조할 수 있도록 아이템을 먼저 생성합니다.
    - name: 2-1. Zabbix SNMP Trap 아이템 생성
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "item.create"
          params:
            name: "SNMP Trap: Link Down/Disabled"
            key_: "snmptrap[link-down]"
            hostid: "10254" # 확인하신 'Arista by SNMP' 템플릿 ID 적용
            type: 17 # SNMP trap
            value_type: 1 # Character
            delay: "0"
          auth: "{{ zabbix_token }}"
          id: 12
      ignore_errors: yes

    - name: 2-2. Zabbix 'err-disable' 트리거 생성 (Polling 방식)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "trigger.create"
          params:
            description: "Auto Recovery: Interface Down detected on {HOST.NAME}"
            # 트랩 대신 포트 상태(net.if.status)가 2(down)인 상태가 지속되면 발동
            expression: "last(/Arista by SNMP/net.if.status[Ethernet1])=2"
            priority: 4
          auth: "{{ zabbix_token }}"
          id: 10
      ignore_errors: yes

    - name: 2-3. Zabbix 자가 치유 Action 생성 (에러 수정본)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "Auto Recovery for err-disable"
            eventsource: 0
            status: 0
            operations:
              - operationtype: 1
                opcommand:
                  # 'type' 파라미터를 완전히 제거하여 32602 에러 방지
                  command: "ansible-playbook -i ansible/inventory/inventory.yml ansible/playbooks/self_healing_port.yml --limit {HOST.NAME}"
                  execute_on: 1
                opcommand_grp:
                  - groupid: "2"
          auth: "{{ zabbix_token }}"
          id: 11