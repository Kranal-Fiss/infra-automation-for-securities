---
# [Play 1] Arista 장비 SNMP 트랩 및 인터페이스 보안 설정 (송신부 구축)
- name: Step 1 - Configure SNMP Traps and Interface Status
  hosts: arista
  gather_facts: no
  connection: network_cli
  tasks:
    - name: 1-1. 글로벌 SNMP 트랩 및 호스트 설정 (v4.35.1F 실물 구문 적용)
      arista.eos.eos_config:
        lines:
          # 직접 검증 완료: version 3와 priv 보안 레벨, udp-port 162 명시
          - snmp-server host 172.20.20.1 version 3 priv {{ snmp_user }} udp-port 162
          
          # 직접 확인 완료: snmp 하위의 세분화된 링크 트랩 활성화
          - snmp-server enable traps snmp link-down
          - snmp-server enable traps snmp link-up
          
          # <cr> 확인 완료: 하위 엔터티(oper-disabled 포함) 트랩 일괄 활성화
          - snmp-server enable traps entity
          
          # 운영 이력 추적을 위한 구성 변경 이벤트 활성화
          - snmp-server enable traps snmpConfigManEvent
      # all.yml의 snmp_user(admin) 변수 참조

    - name: 1-2. 인터페이스별 트랩 발생 활성화 (Arista 가이드라인 반영)
      arista.eos.eos_config:
        # 설명서 가이드: 개별 포트의 link-status 트랩 생성 보장
        lines:
          - snmp trap link-change
        parents: 
          - interface Ethernet1
          - interface Ethernet2
          - interface Ethernet3
      # 기본값이지만 형상 관리의 완결성을 위해 명시적으로 설정함

# [Play 2] Zabbix 서버 트리거 및 자가 치유 액션 설정 (수신 및 처리부 구축)
- name: Step 2 - Configure Zabbix Trigger and Action via API
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - "../inventory/group_vars/all.yml" # Zabbix 접속 정보 및 토큰 참조
  
  tasks:
    - name: Zabbix 'err-disable' 트리거 생성
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "trigger.create"
          params:
            description: "Interface err-disable or Link-down detected on {HOST.NAME}"
            # Trap 데이터 중 link-down 또는 엔터티 장애(Disabled) 감시
            expression: "last(/Arista by SNMP/snmptrap[link-down])<>0 or last(/Arista by SNMP/snmptrap[Disabled])<>0"
            priority: 4 # High (장애 발생 시 즉시 인지)
          auth: "{{ zabbix_token }}"
          id: 10
      register: trigger_resp
      ignore_errors: yes

    - name: Zabbix 자가 치유 Action(Remote Command) 생성
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "Auto Recovery for err-disable"
            eventsource: 0 # Triggers 기반
            status: 0 # Enabled (즉시 활성화)
            operations:
              - operationtype: 1 # Remote command 실행
                opcommand:
                  type: 0 # Custom script 방식
                  # 프로젝트 루트 경로를 동적으로 참조하여 가상환경 내에서 복구 플레이북 실행
                  command: "cd {{ lookup('env', 'PWD') }} && source venv/bin/activate && ansible-playbook -i ansible/inventory/inventory.yml ansible/playbooks/self_healing_port.yml --limit {HOST.NAME}"
                  execute_on: 1 # Zabbix server 호스트에서 실행
                opcommand_grp:
                  - groupid: "2" # Zabbix 내 'Linux servers' 그룹 ID
          auth: "{{ zabbix_token }}"
          id: 11
      ignore_errors: yes