---
- name: Step 1 - Arista 장비 장애 유발 설정 (BPDU Guard)
  hosts: arista
  gather_facts: no
  connection: network_cli
  tasks:
    - name: 1-1. Ethernet1 포트에 BPDU Guard 설정 (image_0418c5.png 반영)
      arista.eos.eos_config:
        lines:
          - switchport
          - spanning-tree portfast  # edge 대신 portfast 사용
          - spanning-tree bpduguard enable
        parents: interface Ethernet1

- name: Step 2 - Zabbix 자가 치유 로직 설정 (API 규격 준수)
  hosts: localhost
  gather_facts: no
  vars_files:
    - ../vars/zabbix_vars.yml
  tasks:
    # TASK 2-1(Item 생성)은 템플릿에 이미 존재하므로 중복 방지를 위해 삭제함

    - name: 2-2. Zabbix 트리거 생성 (Fact 기반 아이템 키 적용)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "trigger.create"
          params:
            description: "Auto Recovery: Ethernet1 Down on {HOST.NAME}"
            # image_056a64.png에서 확인된 정확한 키 사용
            expression: "last(/Arista by SNMP/net.if.status[ifOperStatus.1])=2"
            priority: 4  # High
          auth: "{{ zabbix_token }}"
          id: 10
      register: trigger_result

    - name: 2-3. Zabbix 자가 치유 Action 생성 (6.4/7.0 API 구조 반영)
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "Auto Recovery for err-disable"
            eventsource: 0  # 트리거 이벤트
            status: 0       # 활성화
            filter:
              evaltype: 0
              conditions:
                - conditiontype: 3  # 트리거 이름 기반 필터
                  operator: 2       # 포함(like)
                  value: "Auto Recovery"
            operations:
              - operationtype: 1  # 원격 명령 실행
                opcommand:
                  type: 0         # 사용자 지정 스크립트
                  execute_on: 1   # Zabbix 서버에서 실행
                  # command 파라미터는 opcommand 객체 바로 아래 위치
                  command: "ansible-playbook -i /home/clab/infra-automation-for-securities/ansible/inventory/inventory.yml /home/clab/infra-automation-for-securities/ansible/playbooks/self_healing_port.yml --limit {HOST.NAME}"
                opcommand_grp:
                  - groupid: "2"  # Linux servers 권한 그룹 ID
          auth: "{{ zabbix_token }}"
          id: 11
      register: action_result

    - name: 2-4. 실행 결과 디버깅 (선택 사항)
      ansible.builtin.debug:
        msg: 
          - "Trigger Creation: {{ trigger_result.json.result | default(trigger_result.json.error) }}"
          - "Action Creation: {{ action_result.json.result | default(action_result.json.error) }}"