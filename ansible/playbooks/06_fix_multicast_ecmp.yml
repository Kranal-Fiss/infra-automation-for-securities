---
- name: Step 6. [Patch] 멀티캐스트 라우팅 활성화 및 ECMP 보완 (Final_v4)
  hosts: arista
  gather_facts: no
  vars:
    spt_threshold: "infinity"

  tasks:
    # -------------------------------------------------------
    # 0. [긴급] 전역 멀티캐스트 라우팅 활성화 (가장 중요)
    # -------------------------------------------------------
    - name: 6.0. 전역 멀티캐스트 라우팅 활성화 (Power On)
      arista.eos.eos_config:
        lines:
          - ip multicast-routing
      # 이 설정이 들어가야 아래의 모든 PIM 설정이 동작합니다.

    # -------------------------------------------------------
    # 1. BGP ECMP 경로 확장
    # -------------------------------------------------------
    - name: 6.1. BGP Maximum-Paths 설정 (유니캐스트 ECMP 활성화)
      arista.eos.eos_config:
        lines:
          - maximum-paths 4 ecmp 4
        parents: router bgp {{ bgp_as }}

    # -------------------------------------------------------
    # 2. 멀티캐스트 Multipath (ECMP RPF) 설정
    # -------------------------------------------------------
    - name: 6.2. 멀티캐스트 Multipath (Deterministic) 활성화
      arista.eos.eos_config:
        lines:
          # cEOS 4.35.1F 대응: ECMP 멀티캐스트 활성화
          - ip multicast multipath deterministic

    # -------------------------------------------------------
    # 3. PIM SPT Threshold 설정
    # -------------------------------------------------------
    - name: 6.3. PIM SPT Threshold 설정 (경로 흔들림 방지)
      arista.eos.eos_config:
        lines:
          - spt threshold infinity
        parents:
          - router pim sparse-mode
          - ipv4

    # -------------------------------------------------------
    # 4. 호스트 접점 DR 우선순위 설정
    # -------------------------------------------------------
    - name: 6.4. 호스트 접점(Et3) DR 우선순위 설정
      arista.eos.eos_config:
        lines:
          - ip pim dr-priority 100
        parents: interface Ethernet3

    # -------------------------------------------------------
    # 5. 설정 결과 검증
    # -------------------------------------------------------
    - name: 6.5. PIM RP 및 멀티캐스트 라우팅 상태 확인
      arista.eos.eos_command:
        commands:
          - show ip pim rp
          - show ip route {{ rp_address }}
          # 이제는 에러 메시지 대신 숫자가 나와야 함
          - show ip mroute count
      register: fix_status

    - name: 6.6. 검증 결과 출력
      debug:
        msg:
          - "RP 상태: {{ fix_status.stdout_lines[0] }}"
          - "RP 경로(ECMP) 확인: {{ fix_status.stdout_lines[1] }}"
          - "멀티캐스트 패킷 카운트: {{ fix_status.stdout_lines[2] }}"