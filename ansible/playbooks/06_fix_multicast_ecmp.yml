---
- name: Step 6. [Patch] 멀티캐스트 ECMP 및 IGMP Querier 긴급 보완 (Final Fix)
  hosts: arista
  gather_facts: no
  vars:
    # 트러블슈팅 중 경로 흔들림 방지 (테스트 후 제거 가능)
    spt_threshold: "infinity"

  tasks:
    # -------------------------------------------------------
    # 1. BGP ECMP 경로 확장
    # -------------------------------------------------------
    - name: 6.1. BGP Maximum-Paths 설정 (유니캐스트 ECMP 활성화)
      arista.eos.eos_config:
        lines:
          - maximum-paths 4 ecmp 4
        parents: router bgp {{ bgp_as }}

    # -------------------------------------------------------
    # 2. 멀티캐스트 Multipath (ECMP RPF) 설정 - [확인된 명령어 적용]
    # -------------------------------------------------------
    - name: 6.2. 멀티캐스트 Multipath (Deterministic) 활성화
      arista.eos.eos_config:
        lines:
          # [확인 완료] cEOS 4.35.1F 버전의 ECMP 멀티캐스트 활성화 명령어
          - ip multicast multipath deterministic

    # -------------------------------------------------------
    # 3. PIM SPT Threshold 설정
    # -------------------------------------------------------
    - name: 6.3. PIM SPT Threshold 설정 (경로 흔들림 방지)
      arista.eos.eos_config:
        lines:
          - spt-threshold infinity
        parents: router pim sparse-mode

    # -------------------------------------------------------
    # 4. 호스트 접점 IGMP Querier 설정
    # -------------------------------------------------------
    - name: 6.4. 호스트 접점(Et3) IGMP Querier 및 DR 우선순위 설정
      arista.eos.eos_config:
        lines:
          - ip igmp querier
          - ip pim dr-priority 100
        parents: interface Ethernet3

    # -------------------------------------------------------
    # 5. 설정 결과 검증
    # -------------------------------------------------------
    - name: 6.5. PIM RP 및 RPF 상태 확인
      arista.eos.eos_command:
        commands:
          - show ip pim rp
          - show ip pim rpf {{ rp_address }}
          - show ip mroute count
      register: fix_status

    - name: 6.6. 검증 결과 출력
      debug:
        msg:
          - "RP 상태: {{ fix_status.stdout_lines[0] }}"
          - "RPF 경로 확인: {{ fix_status.stdout_lines[1] }}"