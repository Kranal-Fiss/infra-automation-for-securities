---
- name: Step 3. BGP 오버레이 및 ECMP 설정
  hosts: arista
  gather_facts: no

  tasks:
    - name: 3.1. BGP 기본 설정
      arista.eos.eos_config:
        lines:
          - router bgp {{ bgp_as }}
          - router-id {{ loopback_ip.split('/')[0] }}
          - no bgp default ipv4-unicast
          - maximum-paths 4 ecmp 4

    - name: 3.2. iBGP Neighbor 설정
      arista.eos.eos_config:
        lines:
          - neighbor 1.1.1.1 remote-as {{ bgp_as }}
          - neighbor 1.1.1.1 update-source Loopback0
          - neighbor 2.2.2.2 remote-as {{ bgp_as }}
          - neighbor 2.2.2.2 update-source Loopback0
          - neighbor 3.3.3.3 remote-as {{ bgp_as }}
          - neighbor 3.3.3.3 update-source Loopback0
        parents: router bgp {{ bgp_as }}

    - name: 3.3. Address-Family 활성화
      arista.eos.eos_config:
        lines:
          - address-family ipv4
          - neighbor 1.1.1.1 activate
          - neighbor 2.2.2.2 activate
          - neighbor 3.3.3.3 activate
          - neighbor 1.1.1.1 next-hop-self
          - neighbor 2.2.2.2 next-hop-self
          - neighbor 3.3.3.3 next-hop-self
        parents: router bgp {{ bgp_as }}