---
# [Play 1] Arista 장비 SNMP 트랩 설정 (자가 치유의 송신부)
- name: Step 1 - Configure SNMP Traps on Arista Switches
  hosts: arista
  gather_facts: no
  connection: network_cli
  tasks:
    - name: SNMP 트랩 및 호스트 설정 주입 (v4.35.1F 구문 적용)
      arista.eos.eos_config:
        lines:
          # 직접 테스트하신 최적화된 구문을 적용합니다.
          - snmp-server host 172.20.20.1 version 3 priv {{ snmp_user }} udp-port 162
          - snmp-server enable traps link
          - snmp-server enable traps errdisable
      # ansible/inventory/group_vars/all.yml의 snmp_user(admin) 참조

# [Play 2] Zabbix 서버 트리거 및 자가 치유 액션 설정 (자가 치유의 수신 및 실행부)
- name: Step 2 - Configure Zabbix Trigger and Action via API
  hosts: localhost
  connection: local
  vars_files:
    - "../inventory/group_vars/all.yml" # Zabbix URL 및 Token 참조
  
  tasks:
    - name: Zabbix 'err-disable' 트리거 생성
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "trigger.create"
          params:
            description: "Interface err-disable detected on {HOST.NAME}"
            # SNMP Trap 수신 데이터 중 err-disable 키워드 감시
            expression: "last(/Arista by SNMP/snmptrap[err-disable])<>0"
            priority: 4 # High
          auth: "{{ zabbix_token }}"
          id: 10
      register: trigger_resp
      ignore_errors: yes # 이미 존재할 경우 무시하고 다음 단계 진행

    - name: Zabbix 자가 치유 Action(Remote Command) 생성
      ansible.builtin.uri:
        url: "{{ zabbix_url }}/api_jsonrpc.php"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          method: "action.create"
          params:
            name: "Auto Recovery for err-disable"
            eventsource: 0 # Triggers
            status: 0 # Enabled
            operations:
              - operationtype: 1 # Remote command
                opcommand:
                  type: 0 # Custom script
                  # 프로젝트 루트 경로를 동적으로 참조하여 venv 환경에서 복구 플레이북 실행
                  command: "cd {{ lookup('env', 'PWD') }} && source venv/bin/activate && ansible-playbook -i ansible/inventory/inventory.yml ansible/playbooks/self_healing_port.yml --limit {HOST.NAME}"
                  execute_on: 1 # Zabbix server에서 실행
                opcommand_grp:
                  - groupid: "2" # Zabbix 내 'Linux servers' 그룹 ID (환경에 맞게 조정 가능)
          auth: "{{ zabbix_token }}"
          id: 11
      ignore_errors: yes