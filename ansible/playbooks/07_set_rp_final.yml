---
- name: Step 7. [Final] RP 지정 및 최종 전송 검증 (Fix_v2)
  hosts: arista
  gather_facts: no
  vars:
    target_rp_address: "3.3.3.3"

  tasks:
    # 1, 2번은 이미 적용되었으므로 Ansible이 알아서 Skip하거나 멱등성을 유지합니다.
    - name: 7.1. 정적 RP 주소 설정
      arista.eos.eos_config:
        lines:
          - ip pim rp-address {{ target_rp_address }}

    - name: 7.2. 물리 인터페이스 PIM 활성화 재확인
      arista.eos.eos_config:
        lines:
          - ip pim sparse-mode
        parents: "interface {{ item.key }}"
      loop: "{{ interfaces | dict2items }}"

    # -------------------------------------------------------
    # 3. 최종 상태 검증 (명령어 수정됨)
    # -------------------------------------------------------
    - name: 7.3. RP 상태 및 RPF 경로 확인
      arista.eos.eos_command:
        commands:
          - show ip pim rp
          # [수정] show ip pim rpf 대신 유니캐스트 라우팅 테이블 확인
          - show ip route {{ target_rp_address }}
      register: final_status

    - name: 7.4. 보기 좋게 결과 출력
      debug:
        msg:
          - "========================================"
          - "1. RP 설정 확인: {{ final_status.stdout_lines[0] }}"
          - "2. RPF 경로(ECMP): {{ final_status.stdout_lines[1] }}"
          - "========================================"